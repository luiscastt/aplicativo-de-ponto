import{m as e,r as N}from"./vendor-CTLkAQ17.js";import{a as A,b as re,u as te}from"./vendor-supabase-query-BZ8e5l_3.js";import{B as o,s as w,u as ie,b as L}from"./index-BTnllf_j.js";import{I as j}from"./input-BjE4wIy-.js";import{L as x}from"./label-DoZpU7nD.js";import{C,a as R,b as M,d as S}from"./card-Cv3fZd4i.js";import{T as le,a as ne,b as $,c as v,d as oe,e as b}from"./table-DuTSpFz9.js";import{D as O,a as Q,b as G,c as H,d as K,e as J,f as de}from"./dialog-CSShFCkQ.js";import{S as W,a as X,b as Y,c as Z,d as p}from"./select-DRKyGRlm.js";import{s as d,a as z}from"./toast-BTgtjvQY.js";import{L as T,f as ce,g as me,R as ue,h as B,T as V}from"./vendor-icons-BvmhBeEN.js";import"./vendor-react-router-xEMQRDFj.js";const xe=async(a,t)=>{const{error:r}=await w.from("profiles").update({first_name:t.first_name,role:t.role,updated_at:new Date().toISOString()}).eq("id",a);if(r)throw r;return await w.from("audit_logs").insert({user_id:a,action:"perfil_atualizado",details:{updated_fields:Object.keys(t)}}),{success:!0,message:"Perfil atualizado!"}},he=({user:a,isOpen:t,onOpenChange:r,onSuccess:c})=>{const m=A({mutationFn:({userId:i,data:l})=>xe(i,l),onSuccess:i=>{c(),r(!1)},onError:i=>d(`Erro: ${i.message}`)}),u=i=>{if(i.preventDefault(),!a)return;const l=i.currentTarget,n={first_name:l.elements.namedItem("edit_first_name").value.trim(),role:l.elements.namedItem("edit_role").value};if(!n.first_name){d("Nome é obrigatório.");return}m.mutate({userId:a.id,data:n})};return a?e.jsx(O,{open:t,onOpenChange:r,children:e.jsxs(Q,{className:"sm:max-w-[425px]",children:[e.jsxs(G,{children:[e.jsxs(H,{className:"text-card-foreground",children:["Editar ",a.first_name]}),e.jsx(K,{children:"Atualize nome e role. A senha permanece a mesma."})]}),e.jsxs("form",{onSubmit:u,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"edit_first_name",children:"Nome Completo"}),e.jsx(j,{id:"edit_first_name",name:"edit_first_name",defaultValue:a.first_name||"",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Email (não editável)"}),e.jsx(j,{value:a.email,disabled:!0,className:"bg-gray-100"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"edit_role",children:"Role"}),e.jsxs(W,{name:"edit_role",defaultValue:a.role,children:[e.jsx(X,{id:"edit_role",children:e.jsx(Y,{})}),e.jsxs(Z,{children:[e.jsx(p,{value:"colaborador",children:"Colaborador"}),e.jsx(p,{value:"gestor",children:"Gestor"}),e.jsx(p,{value:"admin",children:"Admin"})]})]})]}),e.jsx(J,{children:e.jsx(o,{type:"submit",disabled:m.isPending,children:m.isPending?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"mr-2 h-4 w-4 animate-spin"}),"Salvando..."]}):"Salvar Alterações"})})]})]})}):null},fe=async(a,t=1,r=10)=>{let c=w.from("profiles").select("id, first_name, last_name, email, role, updated_at",{count:"exact"}).order("first_name",{ascending:!0});if(a!=null&&a.trim()){const n=`%${a.trim()}%`;c=c.or(`email.ilike.${n},first_name.ilike.${n},last_name.ilike.${n}`)}const m=c.range((t-1)*r,t*r-1),{data:u,error:i,count:l}=await m;if(i)throw i;return{users:u||[],total:l||0}},je=async a=>{const{data:t,error:r}=await w.functions.invoke("create-user",{body:a});if(r)throw r;return t},pe=async a=>{const{data:t,error:r}=await w.functions.invoke("delete-user",{body:{user_id:a}});if(r)throw r;return t},Fe=()=>{const{user:a}=ie(),[t,r]=N.useState(!1),[c,m]=N.useState(null),[u,i]=N.useState(""),[l,n]=N.useState(1),D=10,E=re(),{data:h,isLoading:k,refetch:ee}=te({queryKey:["users",u,l],queryFn:()=>fe(u,l,D)}),y=(h==null?void 0:h.users)||[],P=(h==null?void 0:h.total)||0,_=N.useMemo(()=>Math.ceil(P/D),[P,D]),F=A({mutationFn:je,onSuccess:s=>{s.success?(z(s.message||"Usuário criado com sucesso!"),r(!1),i(""),E.invalidateQueries({queryKey:["users"]})):d(s.error||"Erro ao criar usuário.")},onError:s=>d(`Erro: ${s.message}`)}),q=A({mutationFn:pe,onSuccess:(s,g)=>{s.success?(z(s.message||"Usuário removido com sucesso!"),E.invalidateQueries({queryKey:["users"]})):d(s.error||"Erro ao remover usuário.")},onError:s=>d(`Erro: ${s.message}`)}),se=s=>{s.preventDefault();const g=s.currentTarget,f={first_name:g.elements.namedItem("first_name").value.trim(),email:g.elements.namedItem("email").value.trim().toLowerCase(),password:g.elements.namedItem("password").value,role:g.elements.namedItem("role").value};if(!f.first_name||!f.email||!f.password){d("Nome, email e senha são obrigatórios.");return}if(f.password.length<6){d("Senha deve ter pelo menos 6 caracteres.");return}if(!["colaborador","gestor","admin"].includes(f.role)){d("Role inválido.");return}F.mutate(f)},I=s=>{if(s.id===(a==null?void 0:a.id)){d("Você não pode deletar sua própria conta através do painel.");return}confirm(`Confirmar remoção de ${s.email}? Isso deletará o perfil e a conta de autenticação.`)&&q.mutate(s.id)},U=s=>{m(s)},ae=()=>{z("Perfil atualizado!"),E.invalidateQueries({queryKey:["users"]})};return(a==null?void 0:a.role)==="gestor"||(a==null?void 0:a.role)==="admin"?e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground",children:"Gestão de Usuários"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Crie, edite e gerencie contas de colaboradores."})]}),e.jsx("div",{className:"mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center",children:e.jsxs(O,{open:t,onOpenChange:r,children:[e.jsx(de,{asChild:!0,children:e.jsxs(o,{className:"mt-4 sm:mt-0 w-full sm:w-auto",children:[e.jsx(ce,{className:"mr-2 h-4 w-4"}),"Adicionar Usuário"]})}),e.jsxs(Q,{className:"sm:max-w-[425px]",children:[e.jsxs(G,{children:[e.jsx(H,{className:"text-card-foreground",children:"Criar Novo Usuário"}),e.jsx(K,{children:"Preencha para criar conta completa (auth + profile). Senha mínima: 6 caracteres."})]}),e.jsxs("form",{onSubmit:se,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"first_name",children:"Nome Completo"}),e.jsx(j,{id:"first_name",name:"first_name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"email",children:"Email"}),e.jsx(j,{id:"email",name:"email",type:"email",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"password",children:"Senha"}),e.jsx(j,{id:"password",name:"password",type:"password",minLength:6,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"role",children:"Role"}),e.jsxs(W,{name:"role",defaultValue:"colaborador",children:[e.jsx(X,{id:"role",children:e.jsx(Y,{placeholder:"Selecione role"})}),e.jsxs(Z,{children:[e.jsx(p,{value:"colaborador",children:"Colaborador"}),e.jsx(p,{value:"gestor",children:"Gestor"}),e.jsx(p,{value:"admin",children:"Admin"})]})]})]}),e.jsx(J,{children:e.jsx(o,{type:"submit",disabled:F.isPending,children:F.isPending?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"mr-2 h-4 w-4 animate-spin"}),"Criando..."]}):"Criar Usuário"})})]})]})]})}),e.jsx(C,{className:"mb-6",children:e.jsx(S,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 items-center",children:[e.jsxs("div",{className:"flex-1 relative w-full sm:w-auto",children:[e.jsx(me,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(j,{placeholder:"Buscar por nome ou email...",value:u,onChange:s=>{i(s.target.value),n(1)},className:"pl-10"})]}),e.jsxs("div",{className:"text-sm text-muted-foreground flex-shrink-0",children:["Mostrando ",y.length," de ",P," usuários"]}),e.jsx(o,{variant:"outline",size:"icon",onClick:()=>ee(),disabled:k,children:e.jsx(ue,{className:`h-4 w-4 ${k?"animate-spin":""}`})})]})})}),e.jsxs(C,{children:[e.jsx(R,{children:e.jsx(M,{className:"text-card-foreground",children:"Lista de Usuários"})}),e.jsx(S,{children:k?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(T,{className:"h-8 w-8 animate-spin"})}):y.length===0?e.jsxs("div",{className:"text-left py-8 text-muted-foreground",children:["Nenhum usuário encontrado. ",u&&"Tente ajustar a busca.",e.jsx(o,{onClick:()=>{i(""),n(1)},className:"ml-2",variant:"link",children:"Limpar Busca"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block",children:e.jsxs(le,{children:[e.jsx(ne,{children:e.jsxs($,{children:[e.jsx(v,{children:"Nome"}),e.jsx(v,{children:"Email"}),e.jsx(v,{children:"Role"}),e.jsx(v,{children:"Data de Atualização"}),e.jsx(v,{children:"Ações"})]})}),e.jsx(oe,{children:y.map(s=>e.jsxs($,{children:[e.jsxs(b,{className:"font-medium text-card-foreground",children:[s.first_name," ",s.last_name||""]}),e.jsx(b,{className:"text-card-foreground",children:s.email}),e.jsx(b,{children:e.jsx(L,{variant:s.role==="colaborador"?"secondary":"default",children:s.role})}),e.jsx(b,{className:"text-card-foreground",children:new Date(s.updated_at||"").toLocaleDateString("pt-BR")}),e.jsxs(b,{className:"space-x-2",children:[e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>U(s),children:e.jsx(B,{className:"h-4 w-4"})}),e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>I(s),className:"text-red-600 hover:text-red-800",disabled:q.isPending,children:e.jsx(V,{className:"h-4 w-4"})})]})]},s.id))})]})}),e.jsx("div",{className:"md:hidden space-y-4",children:y.map(s=>e.jsx(C,{className:"shadow-sm",children:e.jsxs(S,{className:"p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("p",{className:"font-semibold text-base truncate text-card-foreground",children:[s.first_name," ",s.last_name||""]}),e.jsx(L,{variant:s.role==="colaborador"?"secondary":"default",className:"ml-2 flex-shrink-0",children:s.role})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.email}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Atualizado em: ",new Date(s.updated_at||"").toLocaleDateString("pt-BR")]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2",children:[e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>U(s),children:e.jsx(B,{className:"h-4 w-4"})}),e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>I(s),className:"text-red-600 hover:text-red-800",disabled:q.isPending,children:e.jsx(V,{className:"h-4 w-4"})})]})]})},s.id))}),_>1&&e.jsxs("div",{className:"flex justify-between items-center mt-6",children:[e.jsx(o,{variant:"outline",size:"sm",onClick:()=>n(s=>Math.max(s-1,1)),disabled:l===1,children:"Anterior"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Página ",l," de ",_]}),e.jsx(o,{variant:"outline",size:"sm",onClick:()=>n(s=>Math.min(s+1,_)),disabled:l===_,children:"Próxima"})]})]})})]}),e.jsx(he,{user:c,isOpen:!!c,onOpenChange:s=>{s||m(null)},onSuccess:ae})]}):e.jsx("div",{className:"w-full",children:e.jsxs(C,{children:[e.jsx(R,{children:e.jsx(M,{className:"text-card-foreground text-left",children:"Gestão de Usuários"})}),e.jsx(S,{className:"text-left text-red-500",children:e.jsx("p",{children:"Acesso negado. Apenas gestores e admins podem gerenciar usuários."})})]})})};export{Fe as default};
