import{r as m,m as s}from"./vendor-CTLkAQ17.js";import{b as F,u as b,a as $}from"./vendor-supabase-query-BZ8e5l_3.js";import{C as y,a as v,b as _,d as I,e as P}from"./card-Cv3fZd4i.js";import{I as k}from"./input-BjE4wIy-.js";import{u as B,s as u,B as C,c as g}from"./index-BTnllf_j.js";import{S}from"./scroll-area-2rGlh5Z0.js";import{s as K}from"./toast-BTgtjvQY.js";import{M as Q,s as q,L as p,t as T,u as A}from"./vendor-icons-BvmhBeEN.js";import"./vendor-react-router-xEMQRDFj.js";const V=async r=>{const{data:n,error:e}=await u.from("profiles").select("id, first_name, email, role").neq("id",r).order("first_name",{ascending:!0});if(e)throw e;return n.map(t=>({id:t.id,name:t.first_name||t.email||"Usuário Desconhecido",role:t.role}))},z=async(r,n)=>{if(!n)return[];const{data:e,error:t}=await u.from("messages").select(`
      id, sender_id, recipient_id, content, created_at,
      profiles(first_name, email)
    `).or(`and(sender_id.eq.${r},recipient_id.eq.${n}),and(sender_id.eq.${n},recipient_id.eq.${r})`).order("created_at",{ascending:!0}).limit(50);if(t)throw t;return e},H=async(r,n)=>{const{data:{user:e}}=await u.auth.getUser(),t=e==null?void 0:e.id;if(!t)throw new Error("Usuário não autenticado.");const{error:o}=await u.from("messages").insert({sender_id:t,recipient_id:n,content:r});if(o)throw o},se=()=>{const{user:r}=B(),n=F(),[e,t]=m.useState(null),[o,j]=m.useState(""),N=m.useRef(null),d=(r==null?void 0:r.id)||"",{data:i,isLoading:E}=b({queryKey:["chatUsers"],queryFn:()=>V(d),enabled:!!r});m.useEffect(()=>{!e&&i&&i.length>0&&t(i[0])},[i,e]);const{data:f,isLoading:M,refetch:L}=b({queryKey:["messages",e==null?void 0:e.id],queryFn:()=>z(d,(e==null?void 0:e.id)||""),enabled:!!r&&!!e});m.useEffect(()=>{if(!r)return;const a=u.channel("chat_room").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},l=>{const c=l.new;(c.sender_id===d&&c.recipient_id===(e==null?void 0:e.id)||c.sender_id===(e==null?void 0:e.id)&&c.recipient_id===d)&&n.invalidateQueries({queryKey:["messages",e==null?void 0:e.id]})}).subscribe();return()=>{u.removeChannel(a)}},[r,e==null?void 0:e.id,d,n]),m.useEffect(()=>{var a;(a=N.current)==null||a.scrollIntoView({behavior:"smooth"})},[f]);const x=$({mutationFn:a=>H(a,e.id),onSuccess:()=>{j(""),L()},onError:a=>K(`Erro ao enviar mensagem: ${a.message}`)}),U=a=>{a.preventDefault(),o.trim()&&e&&!x.isPending&&x.mutate(o.trim())},D=e?e.name:"Selecione um Contato";return s.jsxs("div",{className:"w-full flex flex-col md:flex-row h-[calc(100vh-100px)]",children:[s.jsxs("div",{className:"mb-6 md:hidden",children:[s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx(Q,{className:"h-6 w-6 text-primary"}),s.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground",children:"Chat Interno"})]}),s.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Comunicação direta entre colaboradores e gestores."})]}),s.jsxs(y,{className:"w-full md:w-64 flex-shrink-0 mb-4 md:mb-0 md:mr-4",children:[s.jsx(v,{className:"p-4 border-b",children:s.jsxs(_,{className:"text-lg text-card-foreground flex items-center",children:[s.jsx(q,{className:"h-4 w-4 mr-2"})," Contatos"]})}),s.jsx(S,{className:"h-full max-h-[300px] md:max-h-[calc(100vh-160px)]",children:s.jsx("div",{className:"p-2 space-y-1",children:E?s.jsx("div",{className:"p-2 text-center",children:s.jsx(p,{className:"h-4 w-4 animate-spin mx-auto"})}):i==null?void 0:i.map(a=>s.jsxs(C,{variant:(e==null?void 0:e.id)===a.id?"default":"ghost",className:"w-full justify-start truncate",onClick:()=>t(a),children:[s.jsx(q,{className:"h-4 w-4 mr-2"})," ",a.name]},a.id))})})]}),s.jsxs(y,{className:"flex-1 flex flex-col",children:[s.jsx(v,{className:"p-4 border-b",children:s.jsx(_,{className:"text-xl text-card-foreground",children:D})}),s.jsx(I,{className:"flex-1 p-4 overflow-hidden",children:s.jsx(S,{className:"h-full pr-4",children:e?M?s.jsx("div",{className:"flex justify-center items-center h-full",children:s.jsx(p,{className:"h-8 w-8 animate-spin text-primary"})}):s.jsxs("div",{className:"space-y-4",children:[f==null?void 0:f.map(a=>{var h,w;const l=a.sender_id===d,c=l?"Você":((h=a.profiles)==null?void 0:h.first_name)||((w=a.profiles)==null?void 0:w.email)||"Desconhecido";return s.jsx("div",{className:g("flex",l?"justify-end":"justify-start"),children:s.jsxs("div",{className:g("max-w-[70%] p-3 rounded-lg shadow-md",l?"bg-primary text-primary-foreground rounded-br-none":"bg-muted text-muted-foreground rounded-tl-none"),children:[s.jsx("p",{className:"font-semibold text-xs mb-1",children:c}),s.jsx("p",{className:"text-sm",children:a.content}),s.jsx("span",{className:g("block text-xs mt-1",l?"text-primary-foreground/80":"text-muted-foreground/80"),children:new Date(a.created_at).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})})]})},a.id)}),s.jsx("div",{ref:N})]}):s.jsxs("div",{className:"flex justify-center items-center h-full text-muted-foreground",children:[s.jsx(T,{className:"h-6 w-6 mr-2"})," Selecione um contato para iniciar a conversa."]})})}),s.jsx(P,{className:"p-4 border-t",children:s.jsxs("form",{onSubmit:U,className:"flex w-full space-x-2",children:[s.jsx(k,{placeholder:e?"Digite sua mensagem...":"Selecione um contato primeiro",value:o,onChange:a=>j(a.target.value),disabled:x.isPending||!e}),s.jsx(C,{type:"submit",size:"icon",disabled:x.isPending||!e,children:x.isPending?s.jsx(p,{className:"h-4 w-4 animate-spin"}):s.jsx(A,{className:"h-4 w-4"})})]})})]})]})};export{se as default};
